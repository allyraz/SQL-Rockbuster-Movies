-- This is a code to show how many of the top 5 customers are based within each country. 
-- This requires the use of subqueries where you query a multiple value result table of the top 5 customers, and specific cities and countries based on the requirements of previous code.

SELECT 
	d.country,
	COUNT (a.customer_id) AS all_customer_count,
	COUNT (DISTINCT top5_customer.customer_id) AS top_customer_count
FROM 
	customer a
INNER JOIN address b ON a.address_id = b.address_id
INNER JOIN city c ON b.city_id = c.city_id
INNER JOIN country d ON c.country_id = d.country_id
LEFT JOIN 
	(SELECT 
		a.customer_id,
		a.first_name,
		a.last_name,
		d.country,
		c.city,
		SUM(e.amount) AS total_amount_paid
	FROM customer a
	INNER JOIN address b ON a.address_id = b.address_id
	INNER JOIN city c ON b.city_id = c.city_id
	INNER JOIN country d ON c.country_id = d.country_id
	INNER JOIN payment e ON a.customer_id = e.customer_id
	WHERE c.city IN ('Aurora','Atlixco','Xintai', 'Adoni', 'Dhule (Dhulia)', 'Kurshiki','Pingxiang','Sivas','Celaya','So Leopoldo')
	GROUP BY 
		a.customer_id,
		a.first_name,
		a.last_name,
		c.city,
		d.country
	ORDER BY total_amount_paid DESC
	LIMIT 5) AS top5_customer ON top5_customer.country = d.country
GROUP BY d.country
ORDER BY top_customer_count DESC
